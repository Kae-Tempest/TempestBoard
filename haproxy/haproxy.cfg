global
    log stdout format raw local0
    maxconn 4096
    user haproxy
    group haproxy
    daemon
    # Enable stats page
    stats socket ipv4@127.0.0.1:9999 level admin
    stats timeout 2m

defaults
    log     global
    mode    http
    option  httplog
    option  dontlognull
    timeout connect 5000
    timeout client  50000
    timeout server  50000
    errorfile 400 /usr/local/etc/haproxy/errors/400.http
    errorfile 403 /usr/local/etc/haproxy/errors/403.http
    errorfile 408 /usr/local/etc/haproxy/errors/408.http
    errorfile 500 /usr/local/etc/haproxy/errors/500.http
    errorfile 502 /usr/local/etc/haproxy/errors/502.http
    errorfile 503 /usr/local/etc/haproxy/errors/503.http
    errorfile 504 /usr/local/etc/haproxy/errors/504.http

# Statistics page
frontend stats
    bind *:8404
    stats enable
    stats uri /
    stats refresh 10s
    stats admin if TRUE

# Main frontend for HTTP traffic
frontend http_front
    bind *:80
    # Define ACLs for path detection
    acl is_api path_beg /api
    # Define routing rules
    use_backend backend_spring if is_api
    default_backend frontend_angular

# Angular application backend
backend frontend_angular
    balance roundrobin
    server angular frontend:4200

# Spring Boot API backend
backend backend_spring
    balance roundrobin
    # Keep /api prefix in URL
    http-request set-path %[path,regsub(^/api/,/)]
    server spring backend:8080
